<!doctype html><html lang=ko dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>개발일지#3 | Goorm.me</title>
<meta name=keywords content>
<meta name=description content="express와 역방향 프록시 기존 백엔드를 http 서버로 구성하고 서버에서 nginx를 통해 역방향 프록시를 구성하여 TLS를 구현하였다.
앱 사전 예약 기능을 개발하면서 휴대전화 인증을 많이 요청하는 악의적인 사용자가 있을 것에 대비하여(이게 지금까지 대비되지 않았다는게 조금 충격적&mldr;) express-rate-limit 라이브러리로 사용량을 제한하도록 했다.
문제는 nginx에서 X-Forwarded-For 헤더까지 설정해주고 있는데도 불구하고 express가 항상 같은 아이피라고 인식하여서, 여러명의 사용자가 휴대전화 인증을 시도하면 제한된다는 것이었다.
# nginx 설정 파일  server { location / { proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Host $http_host; proxy_pass http://127.">
<meta name=author content>
<link rel=canonical href=https://goorm.me/devlog/3/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://goorm.me/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://goorm.me/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://goorm.me/favicon-32x32.png>
<link rel=apple-touch-icon href=https://goorm.me/apple-touch-icon.png>
<link rel=mask-icon href=https://goorm.me/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="개발일지#3">
<meta property="og:description" content="express와 역방향 프록시 기존 백엔드를 http 서버로 구성하고 서버에서 nginx를 통해 역방향 프록시를 구성하여 TLS를 구현하였다.
앱 사전 예약 기능을 개발하면서 휴대전화 인증을 많이 요청하는 악의적인 사용자가 있을 것에 대비하여(이게 지금까지 대비되지 않았다는게 조금 충격적&mldr;) express-rate-limit 라이브러리로 사용량을 제한하도록 했다.
문제는 nginx에서 X-Forwarded-For 헤더까지 설정해주고 있는데도 불구하고 express가 항상 같은 아이피라고 인식하여서, 여러명의 사용자가 휴대전화 인증을 시도하면 제한된다는 것이었다.
# nginx 설정 파일  server { location / { proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Host $http_host; proxy_pass http://127.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://goorm.me/devlog/3/"><meta property="article:section" content="devlog">
<meta property="article:published_time" content="2022-01-27T16:08:38+09:00">
<meta property="article:modified_time" content="2022-01-27T16:08:38+09:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="개발일지#3">
<meta name=twitter:description content="express와 역방향 프록시 기존 백엔드를 http 서버로 구성하고 서버에서 nginx를 통해 역방향 프록시를 구성하여 TLS를 구현하였다.
앱 사전 예약 기능을 개발하면서 휴대전화 인증을 많이 요청하는 악의적인 사용자가 있을 것에 대비하여(이게 지금까지 대비되지 않았다는게 조금 충격적&mldr;) express-rate-limit 라이브러리로 사용량을 제한하도록 했다.
문제는 nginx에서 X-Forwarded-For 헤더까지 설정해주고 있는데도 불구하고 express가 항상 같은 아이피라고 인식하여서, 여러명의 사용자가 휴대전화 인증을 시도하면 제한된다는 것이었다.
# nginx 설정 파일  server { location / { proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Host $http_host; proxy_pass http://127.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Devlogs","item":"https://goorm.me/devlog/"},{"@type":"ListItem","position":3,"name":"개발일지#3","item":"https://goorm.me/devlog/3/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"개발일지#3","name":"개발일지#3","description":"express와 역방향 프록시 기존 백엔드를 http 서버로 구성하고 서버에서 nginx를 통해 역방향 프록시를 구성하여 TLS를 구현하였다.\n앱 사전 예약 기능을 개발하면서 휴대전화 인증을 많이 요청하는 악의적인 사용자가 있을 것에 대비하여(이게 지금까지 대비되지 않았다는게 조금 충격적\u0026hellip;) express-rate-limit 라이브러리로 사용량을 제한하도록 했다.\n문제는 nginx에서 X-Forwarded-For 헤더까지 설정해주고 있는데도 불구하고 express가 항상 같은 아이피라고 인식하여서, 여러명의 사용자가 휴대전화 인증을 시도하면 제한된다는 것이었다.\n# nginx 설정 파일  server { location / { proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Host $http_host; proxy_pass http://127.","keywords":[],"articleBody":"express와 역방향 프록시 기존 백엔드를 http 서버로 구성하고 서버에서 nginx를 통해 역방향 프록시를 구성하여 TLS를 구현하였다.\n앱 사전 예약 기능을 개발하면서 휴대전화 인증을 많이 요청하는 악의적인 사용자가 있을 것에 대비하여(이게 지금까지 대비되지 않았다는게 조금 충격적…) express-rate-limit 라이브러리로 사용량을 제한하도록 했다.\n문제는 nginx에서 X-Forwarded-For 헤더까지 설정해주고 있는데도 불구하고 express가 항상 같은 아이피라고 인식하여서, 여러명의 사용자가 휴대전화 인증을 시도하면 제한된다는 것이었다.\n# nginx 설정 파일  server { location / { proxy_set_header X-Forwarded-For $remote_addr; proxy_set_header X-Forwarded-Proto $scheme; proxy_set_header Host $http_host; proxy_pass http://127.0.0.1:3000; } # ... } 해결 방법은 실로 간단하다. 구태여 글로 쓸 필요도 없다고 느낄 정도다.\nconst app = express(); app.set(\"trust proxy\", 1); // ...  app.listen(80); 왜 이런식으로 하는지 혼자서 생각해본 것인데, 검증되지 않은 어떤 프록시가 X-Forwarded-For 헤더에 다른 사람의 아이피를 넣을 가능성이 있기 때문에 검증된 프록시의 X-Forwarded-For 헤더만 신뢰하도록 한 것 같다. 근데 어차피 같은 네트워크인데 그냥 하면 안되는건가 싶다…\n내가 정말 예상하지 못한 곳에서 취약점이나 버그가 발생할 수 있다는 걸 다시 깨달았다. 깨달은 순간엔 이미 늦은거 같기도 하다.\nECS 공부 ECS에 한번이라도 제대로 배포해보고 싶어서 하루종일 이거만 했는데 잘 안된다. 너무 고통스럽다. 대충 ECS, Service Discovery, Load Balancer등이 어떤식으로 동작하는지는 이해했는데 막상 올리면 배포가 안된다…\n처음부터 다시 차근차근 해봐야겠다.\n","wordCount":"189","inLanguage":"ko","datePublished":"2022-01-27T16:08:38+09:00","dateModified":"2022-01-27T16:08:38+09:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://goorm.me/devlog/3/"},"publisher":{"@type":"Organization","name":"Goorm.me","logo":{"@type":"ImageObject","url":"https://goorm.me/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://goorm.me accesskey=h title="Goorm.me (Alt + H)">Goorm.me</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://goorm.me/archives title=아카이브>
<span>아카이브</span>
</a>
</li>
<li>
<a href=https://goorm.me/categories title=카테고리>
<span>카테고리</span>
</a>
</li>
<li>
<a href=https://goorm.me/tags title=태그>
<span>태그</span>
</a>
</li>
<li>
<a href=https://goorm.me/search title=검색>
<span>검색</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
개발일지#3
</h1>
<div class=post-meta><span title="2022-01-27 16:08:38 +0900 +0900">January 27, 2022</span>
</div>
</header>
<div class=post-content><h2 id=express와-역방향-프록시>express와 역방향 프록시<a hidden class=anchor aria-hidden=true href=#express와-역방향-프록시>#</a></h2>
<p>기존 백엔드를 http 서버로 구성하고 서버에서 nginx를 통해 역방향 프록시를 구성하여 TLS를 구현하였다.</p>
<p>앱 사전 예약 기능을 개발하면서 휴대전화 인증을 많이 요청하는 악의적인 사용자가 있을 것에 대비하여(이게 지금까지 대비되지 않았다는게 조금 충격적&mldr;)
express-rate-limit 라이브러리로 사용량을 제한하도록 했다.</p>
<p>문제는 nginx에서 X-Forwarded-For 헤더까지 설정해주고 있는데도 불구하고 express가 항상 같은 아이피라고 인식하여서,
여러명의 사용자가 휴대전화 인증을 시도하면 제한된다는 것이었다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#75715e># nginx 설정 파일
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>server</span> {
    <span style=color:#f92672>location</span> <span style=color:#e6db74>/</span> {
        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-For</span> $remote_addr;
        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>X-Forwarded-Proto</span> $scheme;
        <span style=color:#f92672>proxy_set_header</span> <span style=color:#e6db74>Host</span> $http_host;
        <span style=color:#f92672>proxy_pass</span> <span style=color:#e6db74>http://127.0.0.1:3000</span>;
    }

    <span style=color:#75715e># ...
</span><span style=color:#75715e></span>}
</code></pre></div><p>해결 방법은 실로 간단하다. 구태여 글로 쓸 필요도 없다고 느낄 정도다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();

<span style=color:#a6e22e>app</span>.<span style=color:#66d9ef>set</span>(<span style=color:#e6db74>&#34;trust proxy&#34;</span>, <span style=color:#ae81ff>1</span>);

<span style=color:#75715e>// ...
</span><span style=color:#75715e></span>
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>80</span>);
</code></pre></div><p>왜 이런식으로 하는지 혼자서 생각해본 것인데,
검증되지 않은 어떤 프록시가 X-Forwarded-For 헤더에 다른 사람의 아이피를 넣을 가능성이 있기 때문에
검증된 프록시의 X-Forwarded-For 헤더만 신뢰하도록 한 것 같다.
근데 어차피 같은 네트워크인데 그냥 하면 안되는건가 싶다&mldr;</p>
<p>내가 정말 예상하지 못한 곳에서 취약점이나 버그가 발생할 수 있다는 걸 다시 깨달았다.
깨달은 순간엔 이미 늦은거 같기도 하다.</p>
<h2 id=ecs-공부>ECS 공부<a hidden class=anchor aria-hidden=true href=#ecs-공부>#</a></h2>
<p>ECS에 한번이라도 제대로 배포해보고 싶어서 하루종일 이거만 했는데 잘 안된다. 너무 고통스럽다.
대충 ECS, Service Discovery, Load Balancer등이 어떤식으로 동작하는지는 이해했는데 막상 올리면 배포가 안된다&mldr;</p>
<p>처음부터 다시 차근차근 해봐야겠다.</p>
</div>
<footer class=post-footer>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://goorm.me>Goorm.me</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>